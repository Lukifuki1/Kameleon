/**
 * @file Vulnerability Management - Enterprise Vulnerability Management Framework
 * @author {{AVTOR}}
 * @version {{VERZIJA}}
 * @date {{DATUM}}
 * @project {{IME_PROJEKTA}}
 * @domain VARNOSTNI_SISTEMI
 * 
 * @requirement REQ-SEC-VUL-001
 * @design DSN-SEC-VUL-001
 * @test TST-SEC-VUL-001
 * 
 * @description
 * Enterprise-grade Vulnerability Management framework implementing CVE tracking,
 * CVSS scoring, vulnerability scanning, patch management, risk assessment,
 * remediation workflows, and compliance reporting with full automation support.
 * 
 * @compliance CVE, CVSS 3.1, NVD, EPSS, CISA KEV, CWE
 * @classification CONFIDENTIAL - Vulnerability Operations
 */

// ═══════════════════════════════════════════════════════════════════════════════
// VULNERABILITY TYPES
// ═══════════════════════════════════════════════════════════════════════════════

export type VulnerabilitySeverity = 'CRITICAL' | 'HIGH' | 'MEDIUM' | 'LOW' | 'INFORMATIONAL';

export type VulnerabilityStatus =
  | 'NEW' | 'CONFIRMED' | 'IN_REMEDIATION' | 'REMEDIATED'
  | 'MITIGATED' | 'ACCEPTED' | 'FALSE_POSITIVE' | 'DEFERRED';

export type VulnerabilityType =
  | 'CODE_INJECTION' | 'SQL_INJECTION' | 'XSS' | 'CSRF' | 'SSRF'
  | 'PATH_TRAVERSAL' | 'BUFFER_OVERFLOW' | 'INTEGER_OVERFLOW'
  | 'USE_AFTER_FREE' | 'RACE_CONDITION' | 'AUTHENTICATION_BYPASS'
  | 'AUTHORIZATION_BYPASS' | 'INFORMATION_DISCLOSURE' | 'DENIAL_OF_SERVICE'
  | 'PRIVILEGE_ESCALATION' | 'REMOTE_CODE_EXECUTION' | 'DESERIALIZATION'
  | 'XXE' | 'OPEN_REDIRECT' | 'CRYPTOGRAPHIC_WEAKNESS' | 'MISCONFIGURATION'
  | 'HARDCODED_CREDENTIALS' | 'INSECURE_DEFAULTS' | 'MISSING_ENCRYPTION'
  | 'WEAK_PASSWORD' | 'OUTDATED_SOFTWARE' | 'UNPATCHED_SYSTEM' | 'OTHER';

export type ScanType =
  | 'NETWORK' | 'WEB_APPLICATION' | 'CONTAINER' | 'CLOUD'
  | 'CODE' | 'CONFIGURATION' | 'COMPLIANCE' | 'AGENT_BASED';

export type ScannerType =
  | 'NESSUS' | 'QUALYS' | 'RAPID7' | 'TENABLE' | 'OPENVAS'
  | 'BURP' | 'OWASP_ZAP' | 'ACUNETIX' | 'NETSPARKER' | 'NIKTO'
  | 'TRIVY' | 'CLAIR' | 'ANCHORE' | 'GRYPE' | 'SNYK'
  | 'SONARQUBE' | 'CHECKMARX' | 'VERACODE' | 'FORTIFY' | 'SEMGREP'
  | 'PROWLER' | 'SCOUT_SUITE' | 'CLOUDSPLOIT' | 'CUSTOM';

export type RemediationType =
  | 'PATCH' | 'UPGRADE' | 'CONFIGURATION_CHANGE' | 'CODE_FIX'
  | 'WORKAROUND' | 'COMPENSATING_CONTROL' | 'ACCEPT_RISK' | 'DECOMMISSION';

// ═══════════════════════════════════════════════════════════════════════════════
// CVE AND CVSS TYPES
// ═══════════════════════════════════════════════════════════════════════════════

export interface CVERecord {
  readonly cveId: string;
  readonly description: string;
  readonly publishedDate: number;
  readonly lastModifiedDate: number;
  readonly cvss: CVSSScore;
  readonly cwe: readonly CWEReference[];
  readonly references: readonly CVEReference[];
  readonly affectedProducts: readonly AffectedProduct[];
  readonly exploitAvailable: boolean;
  readonly exploitMaturity: ExploitMaturity;
  readonly cisaKEV: boolean;
  readonly cisaKEVDueDate: number | null;
  readonly epss: EPSSScore | null;
  readonly patches: readonly PatchInfo[];
}

export interface CVSSScore {
  readonly version: '3.1' | '3.0' | '2.0';
  readonly vectorString: string;
  readonly baseScore: number;
  readonly baseSeverity: VulnerabilitySeverity;
  readonly temporalScore: number | null;
  readonly temporalSeverity: VulnerabilitySeverity | null;
  readonly environmentalScore: number | null;
  readonly environmentalSeverity: VulnerabilitySeverity | null;
  readonly metrics: CVSSMetrics;
}

export interface CVSSMetrics {
  readonly attackVector: 'NETWORK' | 'ADJACENT' | 'LOCAL' | 'PHYSICAL';
  readonly attackComplexity: 'LOW' | 'HIGH';
  readonly privilegesRequired: 'NONE' | 'LOW' | 'HIGH';
  readonly userInteraction: 'NONE' | 'REQUIRED';
  readonly scope: 'UNCHANGED' | 'CHANGED';
  readonly confidentialityImpact: 'NONE' | 'LOW' | 'HIGH';
  readonly integrityImpact: 'NONE' | 'LOW' | 'HIGH';
  readonly availabilityImpact: 'NONE' | 'LOW' | 'HIGH';
  readonly exploitCodeMaturity: 'NOT_DEFINED' | 'UNPROVEN' | 'PROOF_OF_CONCEPT' | 'FUNCTIONAL' | 'HIGH' | null;
  readonly remediationLevel: 'NOT_DEFINED' | 'OFFICIAL_FIX' | 'TEMPORARY_FIX' | 'WORKAROUND' | 'UNAVAILABLE' | null;
  readonly reportConfidence: 'NOT_DEFINED' | 'UNKNOWN' | 'REASONABLE' | 'CONFIRMED' | null;
}

export type ExploitMaturity =
  | 'NOT_DEFINED' | 'UNPROVEN' | 'PROOF_OF_CONCEPT' | 'FUNCTIONAL' | 'HIGH';

export interface CWEReference {
  readonly cweId: string;
  readonly name: string;
  readonly description: string;
  readonly category: string;
}

export interface CVEReference {
  readonly url: string;
  readonly source: string;
  readonly tags: readonly string[];
}

export interface AffectedProduct {
  readonly vendor: string;
  readonly product: string;
  readonly versions: readonly VersionRange[];
  readonly cpe: string | null;
}

export interface VersionRange {
  readonly versionType: 'EXACT' | 'RANGE' | 'LESS_THAN' | 'LESS_THAN_OR_EQUAL';
  readonly version: string;
  readonly versionEndExcluding: string | null;
  readonly versionEndIncluding: string | null;
}

export interface EPSSScore {
  readonly score: number;
  readonly percentile: number;
  readonly date: number;
}

export interface PatchInfo {
  readonly patchId: string;
  readonly vendor: string;
  readonly product: string;
  readonly version: string;
  readonly releaseDate: number;
  readonly url: string;
  readonly description: string;
}

// ═══════════════════════════════════════════════════════════════════════════════
// VULNERABILITY TYPES
// ═══════════════════════════════════════════════════════════════════════════════

export interface Vulnerability {
  readonly vulnerabilityId: string;
  readonly cve: CVERecord | null;
  readonly title: string;
  readonly description: string;
  readonly type: VulnerabilityType;
  readonly severity: VulnerabilitySeverity;
  readonly status: VulnerabilityStatus;
  readonly riskScore: RiskScore;
  readonly affectedAssets: readonly VulnerableAsset[];
  readonly discovery: DiscoveryInfo;
  readonly remediation: RemediationInfo;
  readonly verification: VerificationInfo;
  readonly timeline: VulnerabilityTimeline;
  readonly metadata: VulnerabilityMetadata;
}

export interface RiskScore {
  readonly baseScore: number;
  readonly adjustedScore: number;
  readonly factors: readonly RiskFactor[];
  readonly priority: 'CRITICAL' | 'HIGH' | 'MEDIUM' | 'LOW';
  readonly sla: number;
}

export interface RiskFactor {
  readonly factor: string;
  readonly weight: number;
  readonly value: number;
  readonly description: string;
}

export interface VulnerableAsset {
  readonly assetId: string;
  readonly hostname: string;
  readonly ipAddress: string;
  readonly assetType: AssetType;
  readonly criticality: 'CRITICAL' | 'HIGH' | 'MEDIUM' | 'LOW';
  readonly owner: string | null;
  readonly department: string | null;
  readonly location: string | null;
  readonly affectedComponent: string;
  readonly affectedVersion: string;
  readonly status: VulnerabilityStatus;
  readonly remediationDeadline: number | null;
}

export type AssetType =
  | 'SERVER' | 'WORKSTATION' | 'LAPTOP' | 'MOBILE' | 'NETWORK_DEVICE'
  | 'FIREWALL' | 'DATABASE' | 'APPLICATION' | 'CONTAINER' | 'CLOUD_INSTANCE'
  | 'IOT' | 'OT' | 'OTHER';

export interface DiscoveryInfo {
  readonly discoveredAt: number;
  readonly discoveredBy: string;
  readonly source: DiscoverySource;
  readonly scanner: ScannerInfo | null;
  readonly manualReport: ManualReport | null;
  readonly bugBounty: BugBountyReport | null;
}

export type DiscoverySource =
  | 'AUTOMATED_SCAN' | 'MANUAL_ASSESSMENT' | 'PENETRATION_TEST'
  | 'BUG_BOUNTY' | 'VENDOR_ADVISORY' | 'THREAT_INTELLIGENCE'
  | 'INCIDENT_RESPONSE' | 'CODE_REVIEW' | 'EXTERNAL_REPORT';

export interface ScannerInfo {
  readonly scannerType: ScannerType;
  readonly scanId: string;
  readonly scanDate: number;
  readonly pluginId: string | null;
  readonly pluginName: string | null;
  readonly output: string | null;
}

export interface ManualReport {
  readonly reporter: string;
  readonly reportDate: number;
  readonly methodology: string;
  readonly evidence: readonly string[];
  readonly stepsToReproduce: readonly string[];
}

export interface BugBountyReport {
  readonly platform: string;
  readonly reportId: string;
  readonly reporter: string;
  readonly reportDate: number;
  readonly bountyAmount: number | null;
  readonly status: 'SUBMITTED' | 'TRIAGED' | 'ACCEPTED' | 'RESOLVED' | 'DUPLICATE' | 'INVALID';
}

export interface RemediationInfo {
  readonly status: 'NOT_STARTED' | 'IN_PROGRESS' | 'COMPLETED' | 'VERIFIED' | 'FAILED';
  readonly type: RemediationType;
  readonly plan: RemediationPlan | null;
  readonly actions: readonly RemediationAction[];
  readonly assignee: string | null;
  readonly deadline: number | null;
  readonly completedAt: number | null;
  readonly notes: string | null;
}

export interface RemediationPlan {
  readonly planId: string;
  readonly title: string;
  readonly description: string;
  readonly steps: readonly RemediationStep[];
  readonly estimatedEffort: number;
  readonly requiredResources: readonly string[];
  readonly dependencies: readonly string[];
  readonly rollbackPlan: string | null;
  readonly testingRequired: boolean;
  readonly approvalRequired: boolean;
  readonly approvedBy: string | null;
  readonly approvedAt: number | null;
}

export interface RemediationStep {
  readonly stepId: string;
  readonly order: number;
  readonly description: string;
  readonly type: 'MANUAL' | 'AUTOMATED';
  readonly assignee: string | null;
  readonly estimatedTime: number;
  readonly status: 'PENDING' | 'IN_PROGRESS' | 'COMPLETED' | 'SKIPPED';
  readonly completedAt: number | null;
  readonly notes: string | null;
}

export interface RemediationAction {
  readonly actionId: string;
  readonly actionType: RemediationType;
  readonly description: string;
  readonly target: string;
  readonly executedBy: string;
  readonly executedAt: number;
  readonly status: 'SUCCESS' | 'FAILURE' | 'PARTIAL';
  readonly result: string | null;
  readonly rollbackPerformed: boolean;
}

export interface VerificationInfo {
  readonly verified: boolean;
  readonly verifiedAt: number | null;
  readonly verifiedBy: string | null;
  readonly method: VerificationMethod | null;
  readonly result: VerificationResult | null;
  readonly evidence: readonly string[];
}

export type VerificationMethod =
  | 'RESCAN' | 'MANUAL_TEST' | 'PENETRATION_TEST' | 'CODE_REVIEW' | 'CONFIGURATION_CHECK';

export interface VerificationResult {
  readonly status: 'REMEDIATED' | 'STILL_VULNERABLE' | 'PARTIALLY_REMEDIATED' | 'INCONCLUSIVE';
  readonly details: string;
  readonly scanId: string | null;
}

export interface VulnerabilityTimeline {
  readonly discovered: number;
  readonly confirmed: number | null;
  readonly remediationStarted: number | null;
  readonly remediated: number | null;
  readonly verified: number | null;
  readonly closed: number | null;
  readonly events: readonly TimelineEvent[];
}

export interface TimelineEvent {
  readonly eventId: string;
  readonly timestamp: number;
  readonly eventType: string;
  readonly description: string;
  readonly actor: string;
  readonly automated: boolean;
}

export interface VulnerabilityMetadata {
  readonly createdAt: number;
  readonly createdBy: string;
  readonly updatedAt: number;
  readonly updatedBy: string;
  readonly tags: readonly string[];
  readonly customFields: Readonly<Record<string, unknown>>;
  readonly relatedVulnerabilities: readonly string[];
  readonly relatedIncidents: readonly string[];
}

// ═══════════════════════════════════════════════════════════════════════════════
// SCAN TYPES
// ═══════════════════════════════════════════════════════════════════════════════

export interface VulnerabilityScan {
  readonly scanId: string;
  readonly name: string;
  readonly description: string;
  readonly type: ScanType;
  readonly scanner: ScannerType;
  readonly configuration: ScanConfiguration;
  readonly schedule: ScanSchedule | null;
  readonly targets: readonly ScanTarget[];
  readonly status: ScanStatus;
  readonly results: ScanResults | null;
  readonly metadata: ScanMetadata;
}

export interface ScanConfiguration {
  readonly profile: string;
  readonly depth: 'QUICK' | 'STANDARD' | 'DEEP' | 'COMPREHENSIVE';
  readonly credentials: readonly ScanCredential[];
  readonly exclusions: readonly ScanExclusion[];
  readonly plugins: readonly string[];
  readonly customSettings: Readonly<Record<string, unknown>>;
  readonly maxDuration: number;
  readonly maxConcurrency: number;
  readonly followRedirects: boolean;
  readonly verifySSL: boolean;
}

export interface ScanCredential {
  readonly credentialId: string;
  readonly type: 'SSH' | 'WINDOWS' | 'SNMP' | 'DATABASE' | 'WEB' | 'API';
  readonly name: string;
  readonly targets: readonly string[];
}

export interface ScanExclusion {
  readonly type: 'HOST' | 'PORT' | 'PATH' | 'PLUGIN' | 'VULNERABILITY';
  readonly value: string;
  readonly reason: string;
  readonly expiresAt: number | null;
}

export interface ScanSchedule {
  readonly enabled: boolean;
  readonly frequency: 'HOURLY' | 'DAILY' | 'WEEKLY' | 'MONTHLY' | 'CUSTOM';
  readonly cronExpression: string | null;
  readonly nextRun: number;
  readonly lastRun: number | null;
  readonly timezone: string;
}

export interface ScanTarget {
  readonly targetId: string;
  readonly type: 'IP' | 'CIDR' | 'HOSTNAME' | 'URL' | 'CONTAINER' | 'REPOSITORY';
  readonly value: string;
  readonly credentials: readonly string[];
  readonly tags: readonly string[];
}

export interface ScanStatus {
  readonly status: 'PENDING' | 'RUNNING' | 'COMPLETED' | 'FAILED' | 'CANCELLED' | 'PAUSED';
  readonly startedAt: number | null;
  readonly completedAt: number | null;
  readonly progress: number;
  readonly currentTarget: string | null;
  readonly error: string | null;
}

export interface ScanResults {
  readonly totalVulnerabilities: number;
  readonly criticalCount: number;
  readonly highCount: number;
  readonly mediumCount: number;
  readonly lowCount: number;
  readonly informationalCount: number;
  readonly hostsScanned: number;
  readonly hostsWithVulnerabilities: number;
  readonly newVulnerabilities: number;
  readonly resolvedVulnerabilities: number;
  readonly vulnerabilities: readonly ScanVulnerability[];
  readonly summary: ScanSummary;
}

export interface ScanVulnerability {
  readonly findingId: string;
  readonly cve: string | null;
  readonly title: string;
  readonly description: string;
  readonly severity: VulnerabilitySeverity;
  readonly cvss: number | null;
  readonly host: string;
  readonly port: number | null;
  readonly protocol: string | null;
  readonly service: string | null;
  readonly path: string | null;
  readonly evidence: string | null;
  readonly solution: string | null;
  readonly references: readonly string[];
  readonly pluginId: string | null;
  readonly pluginName: string | null;
  readonly firstSeen: number;
  readonly lastSeen: number;
  readonly status: 'NEW' | 'EXISTING' | 'RESOLVED';
}

export interface ScanSummary {
  readonly duration: number;
  readonly targetsScanned: number;
  readonly targetsReachable: number;
  readonly portsScanned: number;
  readonly servicesIdentified: number;
  readonly pluginsRun: number;
  readonly errorsEncountered: number;
}

export interface ScanMetadata {
  readonly createdAt: number;
  readonly createdBy: string;
  readonly updatedAt: number;
  readonly tags: readonly string[];
  readonly complianceFrameworks: readonly string[];
}

// ═══════════════════════════════════════════════════════════════════════════════
// ASSET INVENTORY TYPES
// ═══════════════════════════════════════════════════════════════════════════════

export interface AssetInventory {
  readonly assetId: string;
  readonly hostname: string;
  readonly ipAddresses: readonly string[];
  readonly macAddresses: readonly string[];
  readonly assetType: AssetType;
  readonly operatingSystem: OperatingSystemInfo | null;
  readonly software: readonly InstalledSoftware[];
  readonly services: readonly RunningService[];
  readonly openPorts: readonly OpenPort[];
  readonly criticality: 'CRITICAL' | 'HIGH' | 'MEDIUM' | 'LOW';
  readonly owner: string | null;
  readonly department: string | null;
  readonly location: string | null;
  readonly tags: readonly string[];
  readonly vulnerabilityCount: VulnerabilityCount;
  readonly lastScanned: number | null;
  readonly lastUpdated: number;
}

export interface OperatingSystemInfo {
  readonly family: 'WINDOWS' | 'LINUX' | 'MACOS' | 'UNIX' | 'OTHER';
  readonly name: string;
  readonly version: string;
  readonly architecture: string;
  readonly patchLevel: string | null;
  readonly endOfLife: number | null;
}

export interface InstalledSoftware {
  readonly name: string;
  readonly vendor: string;
  readonly version: string;
  readonly installDate: number | null;
  readonly cpe: string | null;
  readonly vulnerabilities: readonly string[];
  readonly endOfLife: number | null;
}

export interface RunningService {
  readonly name: string;
  readonly displayName: string;
  readonly status: 'RUNNING' | 'STOPPED' | 'PAUSED' | 'UNKNOWN';
  readonly startType: 'AUTOMATIC' | 'MANUAL' | 'DISABLED';
  readonly port: number | null;
  readonly protocol: string | null;
}

export interface OpenPort {
  readonly port: number;
  readonly protocol: 'TCP' | 'UDP';
  readonly state: 'OPEN' | 'FILTERED' | 'CLOSED';
  readonly service: string | null;
  readonly version: string | null;
  readonly banner: string | null;
}

export interface VulnerabilityCount {
  readonly total: number;
  readonly critical: number;
  readonly high: number;
  readonly medium: number;
  readonly low: number;
  readonly informational: number;
}

// ═══════════════════════════════════════════════════════════════════════════════
// PATCH MANAGEMENT TYPES
// ═══════════════════════════════════════════════════════════════════════════════

export interface PatchManagement {
  readonly patchId: string;
  readonly vendor: string;
  readonly product: string;
  readonly patchName: string;
  readonly description: string;
  readonly releaseDate: number;
  readonly severity: VulnerabilitySeverity;
  readonly cves: readonly string[];
  readonly affectedSystems: readonly string[];
  readonly prerequisites: readonly string[];
  readonly supersedes: readonly string[];
  readonly supersededBy: string | null;
  readonly rebootRequired: boolean;
  readonly deploymentStatus: PatchDeploymentStatus;
  readonly testingStatus: PatchTestingStatus;
  readonly approvalStatus: PatchApprovalStatus;
  readonly metadata: PatchMetadata;
}

export interface PatchDeploymentStatus {
  readonly status: 'NOT_STARTED' | 'IN_PROGRESS' | 'COMPLETED' | 'FAILED' | 'ROLLED_BACK';
  readonly targetSystems: number;
  readonly deployedSystems: number;
  readonly failedSystems: number;
  readonly pendingSystems: number;
  readonly startedAt: number | null;
  readonly completedAt: number | null;
  readonly deployments: readonly PatchDeployment[];
}

export interface PatchDeployment {
  readonly deploymentId: string;
  readonly assetId: string;
  readonly hostname: string;
  readonly status: 'PENDING' | 'DOWNLOADING' | 'INSTALLING' | 'COMPLETED' | 'FAILED' | 'ROLLED_BACK';
  readonly startedAt: number | null;
  readonly completedAt: number | null;
  readonly error: string | null;
  readonly rebootPerformed: boolean;
}

export interface PatchTestingStatus {
  readonly tested: boolean;
  readonly testEnvironment: string | null;
  readonly testedAt: number | null;
  readonly testedBy: string | null;
  readonly testResults: PatchTestResult | null;
}

export interface PatchTestResult {
  readonly status: 'PASSED' | 'FAILED' | 'PARTIAL';
  readonly functionalTests: boolean;
  readonly regressionTests: boolean;
  readonly performanceTests: boolean;
  readonly securityTests: boolean;
  readonly issues: readonly string[];
  readonly notes: string | null;
}

export interface PatchApprovalStatus {
  readonly approved: boolean;
  readonly approvedBy: string | null;
  readonly approvedAt: number | null;
  readonly approvalNotes: string | null;
  readonly emergencyApproval: boolean;
}

export interface PatchMetadata {
  readonly createdAt: number;
  readonly updatedAt: number;
  readonly source: string;
  readonly downloadUrl: string | null;
  readonly fileSize: number | null;
  readonly checksum: string | null;
  readonly tags: readonly string[];
}

// ═══════════════════════════════════════════════════════════════════════════════
// REPORTING TYPES
// ═══════════════════════════════════════════════════════════════════════════════

export interface VulnerabilityReport {
  readonly reportId: string;
  readonly title: string;
  readonly description: string;
  readonly type: ReportType;
  readonly format: 'PDF' | 'HTML' | 'CSV' | 'JSON' | 'XML';
  readonly scope: ReportScope;
  readonly filters: ReportFilters;
  readonly generatedAt: number;
  readonly generatedBy: string;
  readonly data: ReportData;
  readonly distribution: readonly string[];
}

export type ReportType =
  | 'EXECUTIVE_SUMMARY' | 'TECHNICAL_DETAIL' | 'COMPLIANCE'
  | 'TREND_ANALYSIS' | 'REMEDIATION_STATUS' | 'ASSET_VULNERABILITY'
  | 'SCAN_RESULTS' | 'PATCH_STATUS' | 'RISK_ASSESSMENT' | 'CUSTOM';

export interface ReportScope {
  readonly assets: readonly string[];
  readonly assetGroups: readonly string[];
  readonly vulnerabilities: readonly string[];
  readonly severities: readonly VulnerabilitySeverity[];
  readonly statuses: readonly VulnerabilityStatus[];
  readonly dateRange: DateRange | null;
}

export interface DateRange {
  readonly start: number;
  readonly end: number;
}

export interface ReportFilters {
  readonly includeResolved: boolean;
  readonly includeFalsePositives: boolean;
  readonly includeAccepted: boolean;
  readonly minSeverity: VulnerabilitySeverity;
  readonly maxAge: number | null;
  readonly tags: readonly string[];
}

export interface ReportData {
  readonly summary: ReportSummary;
  readonly vulnerabilities: readonly VulnerabilityReportItem[];
  readonly assets: readonly AssetReportItem[];
  readonly trends: TrendData | null;
  readonly compliance: ComplianceData | null;
}

export interface ReportSummary {
  readonly totalVulnerabilities: number;
  readonly openVulnerabilities: number;
  readonly closedVulnerabilities: number;
  readonly bySeverity: Readonly<Record<VulnerabilitySeverity, number>>;
  readonly byStatus: Readonly<Record<VulnerabilityStatus, number>>;
  readonly byType: Readonly<Record<string, number>>;
  readonly averageTimeToRemediate: number | null;
  readonly slaCompliance: number;
  readonly riskScore: number;
}

export interface VulnerabilityReportItem {
  readonly vulnerabilityId: string;
  readonly cve: string | null;
  readonly title: string;
  readonly severity: VulnerabilitySeverity;
  readonly status: VulnerabilityStatus;
  readonly affectedAssets: number;
  readonly discoveredAt: number;
  readonly age: number;
  readonly slaStatus: 'COMPLIANT' | 'AT_RISK' | 'BREACHED';
}

export interface AssetReportItem {
  readonly assetId: string;
  readonly hostname: string;
  readonly criticality: string;
  readonly vulnerabilityCount: VulnerabilityCount;
  readonly riskScore: number;
  readonly lastScanned: number | null;
}

export interface TrendData {
  readonly period: 'DAILY' | 'WEEKLY' | 'MONTHLY';
  readonly dataPoints: readonly TrendDataPoint[];
}

export interface TrendDataPoint {
  readonly timestamp: number;
  readonly totalVulnerabilities: number;
  readonly newVulnerabilities: number;
  readonly resolvedVulnerabilities: number;
  readonly bySeverity: Readonly<Record<VulnerabilitySeverity, number>>;
}

export interface ComplianceData {
  readonly frameworks: readonly ComplianceFramework[];
  readonly overallScore: number;
}

export interface ComplianceFramework {
  readonly name: string;
  readonly version: string;
  readonly controls: readonly ComplianceControl[];
  readonly score: number;
}

export interface ComplianceControl {
  readonly controlId: string;
  readonly name: string;
  readonly status: 'COMPLIANT' | 'NON_COMPLIANT' | 'PARTIALLY_COMPLIANT' | 'NOT_APPLICABLE';
  readonly findings: number;
  readonly description: string;
}

// ═══════════════════════════════════════════════════════════════════════════════
// UI/UX CENTER INTEGRATION
// ═══════════════════════════════════════════════════════════════════════════════

export interface VulnerabilityUIConfig {
  readonly dashboardEnabled: boolean;
  readonly realTimeUpdates: boolean;
  readonly visualizations: readonly VulnVisualization[];
  readonly notifications: VulnNotificationConfig;
  readonly reporting: VulnReportingConfig;
  readonly workflows: VulnWorkflowConfig;
  readonly integrations: VulnIntegrationConfig;
}

export type VulnVisualization =
  | 'SEVERITY_DISTRIBUTION' | 'STATUS_BREAKDOWN' | 'TREND_CHART'
  | 'ASSET_HEATMAP' | 'TOP_VULNERABILITIES' | 'SLA_TRACKER'
  | 'REMEDIATION_PROGRESS' | 'SCAN_COVERAGE' | 'PATCH_STATUS'
  | 'RISK_MATRIX' | 'COMPLIANCE_GAUGE' | 'EPSS_PRIORITY';

export interface VulnNotificationConfig {
  readonly newCritical: boolean;
  readonly newHigh: boolean;
  readonly slaWarning: boolean;
  readonly slaBreach: boolean;
  readonly scanComplete: boolean;
  readonly scanFailed: boolean;
  readonly patchAvailable: boolean;
  readonly cisaKEV: boolean;
  readonly exploitPublished: boolean;
}

export interface VulnReportingConfig {
  readonly autoGenerate: boolean;
  readonly schedules: readonly ReportSchedule[];
  readonly templates: readonly string[];
  readonly distribution: readonly string[];
  readonly retention: number;
}

export interface ReportSchedule {
  readonly reportType: ReportType;
  readonly frequency: 'DAILY' | 'WEEKLY' | 'MONTHLY';
  readonly time: string;
  readonly recipients: readonly string[];
}

export interface VulnWorkflowConfig {
  readonly autoAssignment: boolean;
  readonly assignmentRules: readonly AssignmentRule[];
  readonly escalationRules: readonly EscalationRule[];
  readonly slaDefinitions: readonly SLADefinition[];
  readonly approvalWorkflows: readonly ApprovalWorkflow[];
}

export interface AssignmentRule {
  readonly ruleId: string;
  readonly name: string;
  readonly conditions: readonly RuleCondition[];
  readonly assignee: string;
  readonly priority: number;
}

export interface RuleCondition {
  readonly field: string;
  readonly operator: 'EQUALS' | 'NOT_EQUALS' | 'CONTAINS' | 'GREATER_THAN' | 'LESS_THAN' | 'IN';
  readonly value: unknown;
}

export interface EscalationRule {
  readonly ruleId: string;
  readonly name: string;
  readonly trigger: 'SLA_WARNING' | 'SLA_BREACH' | 'NO_PROGRESS' | 'SEVERITY_CHANGE';
  readonly threshold: number;
  readonly escalateTo: string;
  readonly notificationChannels: readonly string[];
}

export interface SLADefinition {
  readonly severity: VulnerabilitySeverity;
  readonly remediationTime: number;
  readonly warningThreshold: number;
  readonly criticalThreshold: number;
}

export interface ApprovalWorkflow {
  readonly workflowId: string;
  readonly name: string;
  readonly trigger: string;
  readonly approvers: readonly string[];
  readonly requiredApprovals: number;
  readonly timeout: number;
}

export interface VulnIntegrationConfig {
  readonly ticketing: TicketingIntegration | null;
  readonly cicd: CICDIntegration | null;
  readonly siem: SIEMIntegration | null;
  readonly cmdb: CMDBIntegration | null;
}

export interface TicketingIntegration {
  readonly type: 'JIRA' | 'SERVICENOW' | 'ZENDESK' | 'CUSTOM';
  readonly autoCreate: boolean;
  readonly syncStatus: boolean;
  readonly projectKey: string;
  readonly issueType: string;
}

export interface CICDIntegration {
  readonly type: 'JENKINS' | 'GITLAB' | 'GITHUB_ACTIONS' | 'AZURE_DEVOPS' | 'CUSTOM';
  readonly breakBuild: boolean;
  readonly severityThreshold: VulnerabilitySeverity;
  readonly scanOnPR: boolean;
  readonly scanOnMerge: boolean;
}

export interface SIEMIntegration {
  readonly type: 'SPLUNK' | 'ELASTIC' | 'QRADAR' | 'SENTINEL' | 'CUSTOM';
  readonly sendAlerts: boolean;
  readonly sendMetrics: boolean;
  readonly alertSeverity: VulnerabilitySeverity;
}

export interface CMDBIntegration {
  readonly type: 'SERVICENOW' | 'BMC' | 'CUSTOM';
  readonly syncAssets: boolean;
  readonly syncVulnerabilities: boolean;
  readonly syncFrequency: number;
}

// ═══════════════════════════════════════════════════════════════════════════════
// ERROR TYPES
// ═══════════════════════════════════════════════════════════════════════════════

export enum VulnerabilityErrorCode {
  VULNERABILITY_NOT_FOUND = 'VM_E001',
  SCAN_FAILED = 'VM_E002',
  REMEDIATION_FAILED = 'VM_E003',
  VERIFICATION_FAILED = 'VM_E004',
  PATCH_DEPLOYMENT_FAILED = 'VM_E005',
  REPORT_GENERATION_FAILED = 'VM_E006',
  INTEGRATION_ERROR = 'VM_E007',
  INVALID_CVE = 'VM_E008',
}

export class VulnerabilityError extends Error {
  constructor(
    public readonly code: VulnerabilityErrorCode,
    message: string,
    public readonly details: Readonly<Record<string, unknown>> = {}
  ) {
    super(`[${code}] ${message}`);
    this.name = 'VulnerabilityError';
  }
}

// ═══════════════════════════════════════════════════════════════════════════════
// DETERMINISTIC UTILITIES
// ═══════════════════════════════════════════════════════════════════════════════

function deterministicHash(input: string): number {
  let hash = 0;
  for (let i = 0; i < input.length; i++) {
    const char = input.charCodeAt(i);
    hash = ((hash << 5) - hash) + char;
    hash = hash & hash;
  }
  return Math.abs(hash);
}

function generateDeterministicId(prefix: string, seed: number): string {
  const hash = deterministicHash(`${prefix}-${seed}`);
  const jitter = Math.abs(Math.sin(seed * 12.9898) * 43758.5453) % 1;
  return `${prefix}-${hash.toString(16)}-${Math.floor(jitter * 10000).toString(16)}`;
}

function generateDeterministicTimestamp(seed: number): number {
  const baseTime = 1704067200000;
  const offset = Math.abs(deterministicHash(`timestamp-${seed}`)) % 86400000;
  return baseTime + offset;
}

function calculateCVSSScore(metrics: CVSSMetrics): number {
  const avScore: Record<string, number> = { NETWORK: 0.85, ADJACENT: 0.62, LOCAL: 0.55, PHYSICAL: 0.2 };
  const acScore: Record<string, number> = { LOW: 0.77, HIGH: 0.44 };
  const prScore: Record<string, Record<string, number>> = {
    UNCHANGED: { NONE: 0.85, LOW: 0.62, HIGH: 0.27 },
    CHANGED: { NONE: 0.85, LOW: 0.68, HIGH: 0.5 },
  };
  const uiScore: Record<string, number> = { NONE: 0.85, REQUIRED: 0.62 };
  const impactScore: Record<string, number> = { NONE: 0, LOW: 0.22, HIGH: 0.56 };

  const exploitability = 8.22 * avScore[metrics.attackVector] * acScore[metrics.attackComplexity] *
    prScore[metrics.scope][metrics.privilegesRequired] * uiScore[metrics.userInteraction];

  const impactBase = 1 - (1 - impactScore[metrics.confidentialityImpact]) *
    (1 - impactScore[metrics.integrityImpact]) * (1 - impactScore[metrics.availabilityImpact]);

  let impact: number;
  if (metrics.scope === 'UNCHANGED') {
    impact = 6.42 * impactBase;
  } else {
    impact = 7.52 * (impactBase - 0.029) - 3.25 * Math.pow(impactBase - 0.02, 15);
  }

  if (impact <= 0) return 0;

  let baseScore: number;
  if (metrics.scope === 'UNCHANGED') {
    baseScore = Math.min(impact + exploitability, 10);
  } else {
    baseScore = Math.min(1.08 * (impact + exploitability), 10);
  }

  return Math.round(baseScore * 10) / 10;
}

// ═══════════════════════════════════════════════════════════════════════════════
// CVE DATABASE
// ═══════════════════════════════════════════════════════════════════════════════

export class CVEDatabase {
  private operationCounter: number = 0;
  private readonly cves: Map<string, CVERecord> = new Map();

  constructor() {
    this.initializeKnownCVEs();
  }

  private initializeKnownCVEs(): void {
    const knownCVEs: CVERecord[] = [
      {
        cveId: 'CVE-2021-44228',
        description: 'Apache Log4j2 2.0-beta9 through 2.15.0 JNDI features used in configuration, log messages, and parameters do not protect against attacker controlled LDAP and other JNDI related endpoints.',
        publishedDate: 1639094400000,
        lastModifiedDate: 1704067200000,
        cvss: {
          version: '3.1',
          vectorString: 'CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:C/C:H/I:H/A:H',
          baseScore: 10.0,
          baseSeverity: 'CRITICAL',
          temporalScore: null,
          temporalSeverity: null,
          environmentalScore: null,
          environmentalSeverity: null,
          metrics: {
            attackVector: 'NETWORK',
            attackComplexity: 'LOW',
            privilegesRequired: 'NONE',
            userInteraction: 'NONE',
            scope: 'CHANGED',
            confidentialityImpact: 'HIGH',
            integrityImpact: 'HIGH',
            availabilityImpact: 'HIGH',
            exploitCodeMaturity: 'HIGH',
            remediationLevel: 'OFFICIAL_FIX',
            reportConfidence: 'CONFIRMED',
          },
        },
        cwe: [{ cweId: 'CWE-502', name: 'Deserialization of Untrusted Data', description: 'The application deserializes untrusted data without sufficiently verifying that the resulting data will be valid.', category: 'Data Processing Errors' }],
        references: [{ url: 'https://logging.apache.org/log4j/2.x/security.html', source: 'Apache', tags: ['Vendor Advisory'] }],
        affectedProducts: [{ vendor: 'Apache', product: 'Log4j', versions: [{ versionType: 'RANGE', version: '2.0-beta9', versionEndExcluding: '2.17.0', versionEndIncluding: null }], cpe: 'cpe:2.3:a:apache:log4j:*:*:*:*:*:*:*:*' }],
        exploitAvailable: true,
        exploitMaturity: 'HIGH',
        cisaKEV: true,
        cisaKEVDueDate: 1640304000000,
        epss: { score: 0.97565, percentile: 0.99996, date: 1704067200000 },
        patches: [{ patchId: 'LOG4J-2.17.0', vendor: 'Apache', product: 'Log4j', version: '2.17.0', releaseDate: 1639699200000, url: 'https://logging.apache.org/log4j/2.x/download.html', description: 'Upgrade to Log4j 2.17.0 or later' }],
      },
      {
        cveId: 'CVE-2023-44487',
        description: 'The HTTP/2 protocol allows a denial of service (server resource consumption) because request cancellation can reset many streams quickly.',
        publishedDate: 1696896000000,
        lastModifiedDate: 1704067200000,
        cvss: {
          version: '3.1',
          vectorString: 'CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:N/A:H',
          baseScore: 7.5,
          baseSeverity: 'HIGH',
          temporalScore: null,
          temporalSeverity: null,
          environmentalScore: null,
          environmentalSeverity: null,
          metrics: {
            attackVector: 'NETWORK',
            attackComplexity: 'LOW',
            privilegesRequired: 'NONE',
            userInteraction: 'NONE',
            scope: 'UNCHANGED',
            confidentialityImpact: 'NONE',
            integrityImpact: 'NONE',
            availabilityImpact: 'HIGH',
            exploitCodeMaturity: 'HIGH',
            remediationLevel: 'OFFICIAL_FIX',
            reportConfidence: 'CONFIRMED',
          },
        },
        cwe: [{ cweId: 'CWE-400', name: 'Uncontrolled Resource Consumption', description: 'The software does not properly control the allocation and maintenance of a limited resource.', category: 'Resource Management Errors' }],
        references: [{ url: 'https://www.cve.org/CVERecord?id=CVE-2023-44487', source: 'CVE', tags: ['CVE Record'] }],
        affectedProducts: [],
        exploitAvailable: true,
        exploitMaturity: 'HIGH',
        cisaKEV: true,
        cisaKEVDueDate: 1697500800000,
        epss: { score: 0.73214, percentile: 0.98123, date: 1704067200000 },
        patches: [],
      },
      {
        cveId: 'CVE-2024-3094',
        description: 'Malicious code was discovered in the upstream tarballs of xz, starting with version 5.6.0.',
        publishedDate: 1711670400000,
        lastModifiedDate: 1711756800000,
        cvss: {
          version: '3.1',
          vectorString: 'CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:C/C:H/I:H/A:H',
          baseScore: 10.0,
          baseSeverity: 'CRITICAL',
          temporalScore: null,
          temporalSeverity: null,
          environmentalScore: null,
          environmentalSeverity: null,
          metrics: {
            attackVector: 'NETWORK',
            attackComplexity: 'LOW',
            privilegesRequired: 'NONE',
            userInteraction: 'NONE',
            scope: 'CHANGED',
            confidentialityImpact: 'HIGH',
            integrityImpact: 'HIGH',
            availabilityImpact: 'HIGH',
            exploitCodeMaturity: 'FUNCTIONAL',
            remediationLevel: 'OFFICIAL_FIX',
            reportConfidence: 'CONFIRMED',
          },
        },
        cwe: [{ cweId: 'CWE-506', name: 'Embedded Malicious Code', description: 'The product contains code that appears to be malicious in nature.', category: 'Malicious Code' }],
        references: [{ url: 'https://www.openwall.com/lists/oss-security/2024/03/29/4', source: 'oss-security', tags: ['Mailing List'] }],
        affectedProducts: [{ vendor: 'Tukaani', product: 'xz', versions: [{ versionType: 'RANGE', version: '5.6.0', versionEndExcluding: null, versionEndIncluding: '5.6.1' }], cpe: 'cpe:2.3:a:tukaani:xz:*:*:*:*:*:*:*:*' }],
        exploitAvailable: true,
        exploitMaturity: 'FUNCTIONAL',
        cisaKEV: false,
        cisaKEVDueDate: null,
        epss: { score: 0.04321, percentile: 0.91234, date: 1711756800000 },
        patches: [{ patchId: 'XZ-5.4.6', vendor: 'Tukaani', product: 'xz', version: '5.4.6', releaseDate: 1711756800000, url: 'https://github.com/tukaani-project/xz/releases', description: 'Downgrade to xz 5.4.6 or earlier' }],
      },
    ];

    for (const cve of knownCVEs) {
      this.cves.set(cve.cveId, cve);
    }
  }

  getCVE(cveId: string): CVERecord | null {
    return this.cves.get(cveId) ?? null;
  }

  searchCVEs(query: CVESearchQuery): readonly CVERecord[] {
    let results = Array.from(this.cves.values());

    if (query.keyword) {
      const keyword = query.keyword.toLowerCase();
      results = results.filter(cve =>
        cve.cveId.toLowerCase().includes(keyword) ||
        cve.description.toLowerCase().includes(keyword)
      );
    }

    if (query.minSeverity) {
      const severityOrder: VulnerabilitySeverity[] = ['INFORMATIONAL', 'LOW', 'MEDIUM', 'HIGH', 'CRITICAL'];
      const minIndex = severityOrder.indexOf(query.minSeverity);
      results = results.filter(cve => severityOrder.indexOf(cve.cvss.baseSeverity) >= minIndex);
    }

    if (query.cisaKEVOnly) {
      results = results.filter(cve => cve.cisaKEV);
    }

    if (query.exploitAvailable) {
      results = results.filter(cve => cve.exploitAvailable);
    }

    return results;
  }

  addCVE(cve: CVERecord): void {
    this.cves.set(cve.cveId, cve);
  }

  getCVEs(): ReadonlyMap<string, CVERecord> {
    return this.cves;
  }
}

export interface CVESearchQuery {
  readonly keyword?: string;
  readonly minSeverity?: VulnerabilitySeverity;
  readonly cisaKEVOnly?: boolean;
  readonly exploitAvailable?: boolean;
  readonly vendor?: string;
  readonly product?: string;
  readonly dateRange?: DateRange;
}

// ═══════════════════════════════════════════════════════════════════════════════
// VULNERABILITY MANAGER
// ═══════════════════════════════════════════════════════════════════════════════

export class VulnerabilityManager {
  private operationCounter: number = 0;
  private readonly vulnerabilities: Map<string, Vulnerability> = new Map();
  private readonly cveDatabase: CVEDatabase;

  constructor() {
    this.cveDatabase = new CVEDatabase();
  }

  createVulnerability(
    title: string,
    description: string,
    type: VulnerabilityType,
    severity: VulnerabilitySeverity,
    cveId: string | null,
    source: DiscoverySource,
    discoveredBy: string
  ): Vulnerability {
    this.operationCounter++;

    const vulnerabilityId = generateDeterministicId('vuln', this.operationCounter);
    const timestamp = generateDeterministicTimestamp(this.operationCounter);

    const cve = cveId ? this.cveDatabase.getCVE(cveId) : null;

    const vulnerability: Vulnerability = {
      vulnerabilityId,
      cve,
      title,
      description,
      type,
      severity: cve ? cve.cvss.baseSeverity : severity,
      status: 'NEW',
      riskScore: this.calculateRiskScore(severity, cve),
      affectedAssets: [],
      discovery: {
        discoveredAt: timestamp,
        discoveredBy,
        source,
        scanner: null,
        manualReport: null,
        bugBounty: null,
      },
      remediation: {
        status: 'NOT_STARTED',
        type: 'PATCH',
        plan: null,
        actions: [],
        assignee: null,
        deadline: this.calculateDeadline(severity, timestamp),
        completedAt: null,
        notes: null,
      },
      verification: {
        verified: false,
        verifiedAt: null,
        verifiedBy: null,
        method: null,
        result: null,
        evidence: [],
      },
      timeline: {
        discovered: timestamp,
        confirmed: null,
        remediationStarted: null,
        remediated: null,
        verified: null,
        closed: null,
        events: [{
          eventId: generateDeterministicId('event', this.operationCounter),
          timestamp,
          eventType: 'CREATED',
          description: 'Vulnerability created',
          actor: discoveredBy,
          automated: source === 'AUTOMATED_SCAN',
        }],
      },
      metadata: {
        createdAt: timestamp,
        createdBy: discoveredBy,
        updatedAt: timestamp,
        updatedBy: discoveredBy,
        tags: [],
        customFields: {},
        relatedVulnerabilities: [],
        relatedIncidents: [],
      },
    };

    this.vulnerabilities.set(vulnerabilityId, vulnerability);
    return vulnerability;
  }

  private calculateRiskScore(severity: VulnerabilitySeverity, cve: CVERecord | null): RiskScore {
    const severityScore: Record<VulnerabilitySeverity, number> = {
      CRITICAL: 10,
      HIGH: 8,
      MEDIUM: 5,
      LOW: 2,
      INFORMATIONAL: 0,
    };

    let baseScore = severityScore[severity];
    const factors: RiskFactor[] = [];

    if (cve) {
      baseScore = cve.cvss.baseScore;

      if (cve.exploitAvailable) {
        factors.push({ factor: 'Exploit Available', weight: 1.5, value: 1, description: 'Public exploit exists' });
      }

      if (cve.cisaKEV) {
        factors.push({ factor: 'CISA KEV', weight: 2.0, value: 1, description: 'Listed in CISA Known Exploited Vulnerabilities' });
      }

      if (cve.epss && cve.epss.score > 0.5) {
        factors.push({ factor: 'High EPSS', weight: 1.3, value: cve.epss.score, description: `EPSS score: ${cve.epss.score}` });
      }
    }

    let adjustedScore = baseScore;
    for (const factor of factors) {
      adjustedScore *= factor.weight;
    }
    adjustedScore = Math.min(adjustedScore, 10);

    const priority = adjustedScore >= 9 ? 'CRITICAL' : adjustedScore >= 7 ? 'HIGH' : adjustedScore >= 4 ? 'MEDIUM' : 'LOW';
    const slaMap: Record<string, number> = { CRITICAL: 86400000, HIGH: 604800000, MEDIUM: 2592000000, LOW: 7776000000 };

    return {
      baseScore,
      adjustedScore,
      factors,
      priority,
      sla: slaMap[priority],
    };
  }

  private calculateDeadline(severity: VulnerabilitySeverity, timestamp: number): number {
    const slaMap: Record<VulnerabilitySeverity, number> = {
      CRITICAL: 86400000,
      HIGH: 604800000,
      MEDIUM: 2592000000,
      LOW: 7776000000,
      INFORMATIONAL: 31536000000,
    };
    return timestamp + slaMap[severity];
  }

  updateStatus(vulnerabilityId: string, status: VulnerabilityStatus, actor: string): Vulnerability {
    this.operationCounter++;

    const vulnerability = this.vulnerabilities.get(vulnerabilityId);
    if (!vulnerability) {
      throw new VulnerabilityError(VulnerabilityErrorCode.VULNERABILITY_NOT_FOUND, 'Vulnerability not found');
    }

    const timestamp = generateDeterministicTimestamp(this.operationCounter);

    const timelineUpdate = this.getTimelineUpdate(status, timestamp);

    const updatedVulnerability: Vulnerability = {
      ...vulnerability,
      status,
      timeline: {
        ...vulnerability.timeline,
        ...timelineUpdate,
        events: [
          ...vulnerability.timeline.events,
          {
            eventId: generateDeterministicId('event', this.operationCounter),
            timestamp,
            eventType: 'STATUS_CHANGE',
            description: `Status changed to ${status}`,
            actor,
            automated: false,
          },
        ],
      },
      metadata: {
        ...vulnerability.metadata,
        updatedAt: timestamp,
        updatedBy: actor,
      },
    };

    this.vulnerabilities.set(vulnerabilityId, updatedVulnerability);
    return updatedVulnerability;
  }

  private getTimelineUpdate(status: VulnerabilityStatus, timestamp: number): Partial<VulnerabilityTimeline> {
    const updates: Record<VulnerabilityStatus, Partial<VulnerabilityTimeline>> = {
      NEW: {},
      CONFIRMED: { confirmed: timestamp },
      IN_REMEDIATION: { remediationStarted: timestamp },
      REMEDIATED: { remediated: timestamp },
      MITIGATED: { remediated: timestamp },
      ACCEPTED: { closed: timestamp },
      FALSE_POSITIVE: { closed: timestamp },
      DEFERRED: {},
    };
    return updates[status];
  }

  getVulnerabilities(): ReadonlyMap<string, Vulnerability> {
    return this.vulnerabilities;
  }

  getCVEDatabase(): CVEDatabase {
    return this.cveDatabase;
  }
}

// ═══════════════════════════════════════════════════════════════════════════════
// SCAN MANAGER
// ═══════════════════════════════════════════════════════════════════════════════

export class ScanManager {
  private operationCounter: number = 0;
  private readonly scans: Map<string, VulnerabilityScan> = new Map();

  createScan(
    name: string,
    description: string,
    type: ScanType,
    scanner: ScannerType,
    targets: readonly ScanTarget[],
    configuration: ScanConfiguration
  ): VulnerabilityScan {
    this.operationCounter++;

    const scanId = generateDeterministicId('scan', this.operationCounter);
    const timestamp = generateDeterministicTimestamp(this.operationCounter);

    const scan: VulnerabilityScan = {
      scanId,
      name,
      description,
      type,
      scanner,
      configuration,
      schedule: null,
      targets,
      status: {
        status: 'PENDING',
        startedAt: null,
        completedAt: null,
        progress: 0,
        currentTarget: null,
        error: null,
      },
      results: null,
      metadata: {
        createdAt: timestamp,
        createdBy: 'system',
        updatedAt: timestamp,
        tags: [],
        complianceFrameworks: [],
      },
    };

    this.scans.set(scanId, scan);
    return scan;
  }

  startScan(scanId: string): VulnerabilityScan {
    this.operationCounter++;

    const scan = this.scans.get(scanId);
    if (!scan) {
      throw new VulnerabilityError(VulnerabilityErrorCode.SCAN_FAILED, 'Scan not found');
    }

    const timestamp = generateDeterministicTimestamp(this.operationCounter);

    const updatedScan: VulnerabilityScan = {
      ...scan,
      status: {
        ...scan.status,
        status: 'RUNNING',
        startedAt: timestamp,
        progress: 0,
        currentTarget: scan.targets[0]?.value ?? null,
      },
    };

    this.scans.set(scanId, updatedScan);
    return updatedScan;
  }

  completeScan(scanId: string, results: ScanResults): VulnerabilityScan {
    this.operationCounter++;

    const scan = this.scans.get(scanId);
    if (!scan) {
      throw new VulnerabilityError(VulnerabilityErrorCode.SCAN_FAILED, 'Scan not found');
    }

    const timestamp = generateDeterministicTimestamp(this.operationCounter);

    const updatedScan: VulnerabilityScan = {
      ...scan,
      status: {
        ...scan.status,
        status: 'COMPLETED',
        completedAt: timestamp,
        progress: 100,
        currentTarget: null,
      },
      results,
      metadata: {
        ...scan.metadata,
        updatedAt: timestamp,
      },
    };

    this.scans.set(scanId, updatedScan);
    return updatedScan;
  }

  getScans(): ReadonlyMap<string, VulnerabilityScan> {
    return this.scans;
  }
}

// ═══════════════════════════════════════════════════════════════════════════════
// VULNERABILITY MANAGEMENT MANAGER
// ═══════════════════════════════════════════════════════════════════════════════

export class VulnerabilityManagementManager {
  private readonly vulnerabilityManager: VulnerabilityManager;
  private readonly scanManager: ScanManager;
  private readonly uiConfig: VulnerabilityUIConfig;

  constructor(uiConfig: VulnerabilityUIConfig) {
    this.vulnerabilityManager = new VulnerabilityManager();
    this.scanManager = new ScanManager();
    this.uiConfig = uiConfig;
  }

  createVulnerability(
    title: string,
    description: string,
    type: VulnerabilityType,
    severity: VulnerabilitySeverity,
    cveId: string | null,
    source: DiscoverySource,
    discoveredBy: string
  ): Vulnerability {
    return this.vulnerabilityManager.createVulnerability(title, description, type, severity, cveId, source, discoveredBy);
  }

  updateVulnerabilityStatus(vulnerabilityId: string, status: VulnerabilityStatus, actor: string): Vulnerability {
    return this.vulnerabilityManager.updateStatus(vulnerabilityId, status, actor);
  }

  createScan(
    name: string,
    description: string,
    type: ScanType,
    scanner: ScannerType,
    targets: readonly ScanTarget[],
    configuration: ScanConfiguration
  ): VulnerabilityScan {
    return this.scanManager.createScan(name, description, type, scanner, targets, configuration);
  }

  getVulnerabilityManager(): VulnerabilityManager {
    return this.vulnerabilityManager;
  }

  getScanManager(): ScanManager {
    return this.scanManager;
  }
}

// ═══════════════════════════════════════════════════════════════════════════════
// DEFAULT CONFIGURATIONS
// ═══════════════════════════════════════════════════════════════════════════════

export function createDefaultVulnerabilityUIConfig(): VulnerabilityUIConfig {
  return {
    dashboardEnabled: true,
    realTimeUpdates: true,
    visualizations: [
      'SEVERITY_DISTRIBUTION', 'STATUS_BREAKDOWN', 'TREND_CHART',
      'ASSET_HEATMAP', 'TOP_VULNERABILITIES', 'SLA_TRACKER',
      'REMEDIATION_PROGRESS', 'SCAN_COVERAGE', 'EPSS_PRIORITY',
    ],
    notifications: {
      newCritical: true,
      newHigh: true,
      slaWarning: true,
      slaBreach: true,
      scanComplete: true,
      scanFailed: true,
      patchAvailable: true,
      cisaKEV: true,
      exploitPublished: true,
    },
    reporting: {
      autoGenerate: true,
      schedules: [
        { reportType: 'EXECUTIVE_SUMMARY', frequency: 'WEEKLY', time: '09:00', recipients: ['security-team@company.com'] },
        { reportType: 'TECHNICAL_DETAIL', frequency: 'DAILY', time: '08:00', recipients: ['vuln-team@company.com'] },
      ],
      templates: ['executive_summary', 'technical_detail', 'compliance_report'],
      distribution: ['security-team@company.com'],
      retention: 31536000000,
    },
    workflows: {
      autoAssignment: true,
      assignmentRules: [],
      escalationRules: [],
      slaDefinitions: [
        { severity: 'CRITICAL', remediationTime: 86400000, warningThreshold: 0.5, criticalThreshold: 0.8 },
        { severity: 'HIGH', remediationTime: 604800000, warningThreshold: 0.5, criticalThreshold: 0.8 },
        { severity: 'MEDIUM', remediationTime: 2592000000, warningThreshold: 0.5, criticalThreshold: 0.8 },
        { severity: 'LOW', remediationTime: 7776000000, warningThreshold: 0.5, criticalThreshold: 0.8 },
      ],
      approvalWorkflows: [],
    },
    integrations: {
      ticketing: null,
      cicd: null,
      siem: null,
      cmdb: null,
    },
  };
}
